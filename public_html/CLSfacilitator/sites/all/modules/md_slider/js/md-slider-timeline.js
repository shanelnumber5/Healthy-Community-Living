(function(b){var a=function(c){var d=this;this.panel=c;this.selectedItem=null;this.textItemTemplate='<div class="md-item clearfix"><div class="mdi-view"><a href="#" class="btn-viewlayer"></a></div><div class="mdi-name"><span class="mdit-text"></span><span class="title">&nbsp;</span><a href="#" class="btn-deletelayer"></a><a href="#" class="btn-clonelayer"></a></div><div class="mdtl-times"><div class="mdi-frame"></div></div></div>';this.imageItemTemplate='<div class="md-item clearfix"><div class="mdi-view"><a href="#" class="btn-viewlayer"></a></div><div class="mdi-name"><span class="mdit-image"></span><span class="title">&nbsp;</span><a href="#" class="btn-deletelayer"></a><a href="#" class="btn-clonelayer"></a></div><div class="mdtl-times"><div class="mdi-frame"></div></div></div>';this.videoItemTemplate='<div class="md-item clearfix"><div class="mdi-view"><a href="#" class="btn-viewlayer"></a></div><div class="mdi-name"><span class="mdit-video"></span><span class="title">&nbsp;</span><a href="#" class="btn-deletelayer"></a><a href="#" class="btn-clonelayer"></a></div><div class="mdtl-times"><div class="mdi-frame"></div></div></div>';this.maxStart=0;this.rulewidth=7;this.init=function(){d.rulewidth=b(".mdtl-ruler").width()/200;b("#slideshow-time").css("left",100*d.rulewidth);b("#timeline-items").width(100*d.rulewidth+257);b("a.btn-viewlayer").live("click",function(){var f=b(this).parent().parent();var e=f.data("box");if(e!=null){if(b(this).hasClass("btn-blank")){e.show();e.attr("ishidden","false");f.removeClass("box-hide");b(this).removeClass("btn-blank")}else{e.hide();e.attr("ishidden","true");e.removeClass("ui-selected");f.addClass("box-hide");d.panel.triggerChangeSelectItem();b(this).addClass("btn-blank")}}return false});b("a.btn-deletelayer").live("click",function(){var f=b(this).parent().parent();var e=f.data("box");if(e!=null){f.remove();e.remove();d.panel.triggerChangeSelectItem()}return false});b("a.btn-clonelayer").live("click",function(){var f=b(this).parent().parent();var e=f.data("box");if(e!=null){d.panel.cloneBoxItem(e)}return false});b("#timeline-items").sortable({handle:".mdi-name",update:function(e,f){d.triggerChangeOrderItem()},placeholder:"md-item"});b("#slideshow-time").draggable({axis:"x",grid:[d.rulewidth,20],containment:"parent",drag:function(f,e){if(e.position.left<=d.maxStart+d.rulewidth){return false}return d.updateTimelineWidth()}})};this.updateTimelineWidth=function(){var e=b("#slideshow-time").position().left;d.panel.setTimelineWidth(Math.round(e/d.rulewidth));b("#timeline-items").width(257+e);b("#timeline-items .md-item").each(function(){var g=b(this).find(".mdi-frame");var f=b(this).data("box");if(f!=null&&g.position().left+g.width()>e){g.width(e-g.position().left);f.data("stoptime",e/d.rulewidth*100);d.panel.changeTimelineValue()}});return true};this.addTimelineItem=function(e,g){var f;if(e=="text"){f=b(this.textItemTemplate).clone()}else{if(e=="image"){f=b(this.imageItemTemplate).clone()}else{f=b(this.videoItemTemplate).clone()}}var j=g.data("title");f.find("span.title").html(j);var i=g.data("starttime")?g.data("starttime"):0;var h=g.data("stoptime")?g.data("stoptime"):Math.round((b("#timeline-items").width()-257)/d.rulewidth*100);if(h>i){f.find("div.mdi-frame").css({left:i*d.rulewidth/100,width:(h-i)*d.rulewidth/100});if(g.data("starttime")==null||g.data("stoptime")==null){g.data("starttime",i);g.data("stoptime",h);d.panel.changeTimelineValue()}}f.data("box",g);if(g.attr("ishidden")=="true"){f.addClass("box-hide");b("a.btn-viewlayer",f).addClass("btn-blank")}b("#timeline-items").prepend(f);b(f).find("div.mdi-frame").draggable({containment:"parent",grid:[d.rulewidth,20],stop:function(n,o){var m=b(this).parent().parent();var l=m.data("box");if(l!=null){var k=b(o.helper).position();l.data("starttime",k.left/d.rulewidth*100);l.data("stoptime",(k.left+b(o.helper).width())/d.rulewidth*100);if(l.hasClass("ui-selected")){d.panel.triggerChangeSettingItem()}}d.changeMaxStart()}});b(f.find("div.mdi-frame")).resizable({handles:"e, w",containment:"parent",minWidth:2*d.rulewidth,grid:[d.rulewidth,20],stop:function(n,o){var m=b(this).parent().parent();var l=m.data("box");if(l!=null){var k=b(o.helper).position();l.data("starttime",Math.round(k.left/d.rulewidth*100));l.data("stoptime",Math.round((k.left+b(o.helper).width())/d.rulewidth*100));if(l.hasClass("ui-selected")){d.panel.triggerChangeSettingItem()}}d.changeMaxStart()}});b(f).click(function(){if(!b(this).hasClass("active")&&!b(this).hasClass("box-hide")){var k=b(this).data("box");if(k!=null){d.panel.changeSelectItem(k)}}});g.data("timeline",f)};this.changeMaxStart=function(){var e=0;b("#timeline-items .mdtl-times").each(function(){var f=b(this).find("div.mdi-frame").position().left;if(f>e){e=f}});d.maxStart=e};this.changeSelectItem=function(e){this.selectedItem=e;d.triggerChangeSelectItem()};this.triggerChangeSelectItem=function(){b("#timeline-items > div.md-item.active").removeClass("active");if(this.selectedItem!=null){var e=this.selectedItem.data("timeline");if(e!=null){b(e).addClass("active")}}};this.triggerChangeOrderItem=function(){b("#timeline-items .md-item").each(function(e){var f=b(this).data("box");if(f!=null){f.css("z-index",1000-e)}})};this.changeSelectedItemTitle=function(){if(this.selectedItem!=null){var e=this.selectedItem.data("timeline");if(e!=null){var f=this.selectedItem.data("title");b(e).find("span.title").html(f)}}};this.setTimelineWidth=function(e){if(e){b("#slideshow-time").css("left",e*d.rulewidth);d.updateTimelineWidth()}};this.changeActivePanel=function(){b("#timeline-items").html("");var f=d.panel.getTimelineWidth();if(f!=null){d.setTimelineWidth(f)}else{d.panel.setTimelineWidth(b("#slideshow-time").position().left/d.rulewidth)}var e=d.panel.getAllItemBox();e.sort(function(h,g){var i=parseInt(b(h).css("z-index"));var j=parseInt(b(g).css("z-index"));return((i<j)?-1:((i>j)?1:0))});e.each(function(){d.addTimelineItem(b(this).data("type"),b(this))})};this.init()};window.MdSliderTimeline=a})(jQuery);